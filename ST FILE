(* Count first pushbutton presses with Counter1 *)
Counter1(_IO_EM_DI_01, PB1_Reset, 1);
PB1_Activate := Counter1.Q;

(* Use Counter2 + TON_1 to generate reset for Counter1 *)
Counter2(_IO_EM_DI_01, Final_Reset, 2);
TON_1(IN := Counter2.Q, PT := T#1s);
PB1_Reset := TON_1.Q;

(* Count number of valid green button activations into Counter3 *)
Counter3(PB1_Activate AND _IO_EM_DI_00, Final_Reset, 1000);

(* Force the DINT CV from Counter3 into an INT for the rest of the logic *)
PB2_Num := DINT_TO_INT(Counter3.CV);

(* Calculate factorial of PB2_Num *)
(* Use 1â€“7 only: 8! overflows INT (max 32767) *)
IF (PB2_Num > 0) AND (PB2_Num <= 7) THEN
    FactorialResult := 1;

    FOR i := 1 TO PB2_Num DO
        FactorialResult := FactorialResult * i;
    END_FOR;

    FactorialTime := T#1ms * FactorialResult;   (* interpret as milliseconds, e.g. 5! = 120ms *)
ELSE
    FactorialTime := T#0ms;                 (* safe default if out of range / zero *)
END_IF;

(* Red pushbutton: use factorial value as ON time for green stack light *)
IF _IO_EM_DI_01 THEN
    TON_2(IN := TRUE, PT := FactorialTime);
ELSE
    TON_2(IN := FALSE, PT := FactorialTime);
END_IF;

_IO_EM_DO_00 := TON_2.Q;

(* When timer is done while red PB is still pressed, reset counters *)
IF (NOT TON_2.Q) AND _IO_EM_DI_01 THEN
    Final_Reset := TRUE;
ELSE
    Final_Reset := FALSE;
END_IF;
